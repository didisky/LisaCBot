<div class="backtest-container">
  <h2>Strategy Backtest</h2>

  <!-- Current Strategy Card -->
  <div class="current-strategy-card" *ngIf="currentStrategyName">
    <h3>‚öôÔ∏è Strategy to Test</h3>
    <div class="strategy-preview">
      <div class="strategy-name-preview">
        <span class="label">Current Strategy:</span>
        <span class="value strategy-badge-preview">{{ currentStrategyName.toUpperCase() }}</span>
      </div>
      <div class="strategy-parameters-preview" *ngIf="getCurrentParametersArray().length > 0">
        <span class="label">Parameters:</span>
        <div class="params-preview-grid">
          <div *ngFor="let param of getCurrentParametersArray()" class="param-preview-item">
            <span class="param-name">{{ param.key }}:</span>
            <span class="param-value">{{ param.value }}</span>
          </div>
        </div>
      </div>
    </div>
    <p class="info-note">üí° This backtest will use your current active strategy configuration</p>
  </div>

  <div class="backtest-form">
    <div class="form-group">
      <label for="days">Backtest Period (days):</label>
      <input
        type="number"
        id="days"
        name="days"
        [(ngModel)]="config.days"
        min="1"
        max="365"
        class="form-control">
      <small>Test strategy performance over historical data (1-365 days)</small>
    </div>

    <div class="form-group">
      <label for="initialBalance">Initial Balance ($):</label>
      <input
        type="number"
        id="initialBalance"
        name="initialBalance"
        [(ngModel)]="config.initialBalance"
        min="100"
        step="100"
        class="form-control">
      <small>Starting capital for the backtest</small>
    </div>

    <button
      (click)="runBacktest()"
      class="btn-run"
      [disabled]="loading">
      <span *ngIf="!loading">Run Backtest</span>
      <span *ngIf="loading">Running...</span>
    </button>
  </div>

  <div *ngIf="error" class="error-message">
    {{ error }}
  </div>

  <!-- Logs Window -->
  <div *ngIf="logs.length > 0" class="logs-container">
    <h3>Execution Logs</h3>
    <div class="logs-window">
      <div *ngFor="let log of logs" class="log-entry">{{ log }}</div>
    </div>
  </div>

  <!-- Results Section -->
  <div *ngIf="result" class="results" [ngClass]="getResultClass()">
    <h3>{{ getPerformanceIcon() }} Backtest Results</h3>

    <!-- Strategy Information Card -->
    <div class="strategy-info-card">
      <h4>üìä Strategy Information</h4>
      <div class="strategy-details">
        <div class="strategy-name">
          <span class="label">Strategy:</span>
          <span class="value strategy-badge">{{ result.strategyName.toUpperCase() }}</span>
        </div>
        <div class="strategy-parameters">
          <span class="label">Parameters:</span>
          <div class="params-grid">
            <div *ngFor="let param of getParametersArray()" class="param-item">
              <span class="param-name">{{ param.key }}:</span>
              <span class="param-value">{{ param.value }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Performance Card -->
    <div class="performance-card">
      <div class="performance-main">
        <div class="metric">
          <span class="metric-label">Profit/Loss</span>
          <span class="metric-value" [class.positive]="result.profitLoss >= 0" [class.negative]="result.profitLoss < 0">
            ${{ result.profitLoss.toFixed(2) }}
          </span>
        </div>
        <div class="metric">
          <span class="metric-label">Return</span>
          <span class="metric-value" [class.positive]="result.profitLossPercentage >= 0" [class.negative]="result.profitLossPercentage < 0">
            {{ result.profitLossPercentage.toFixed(2) }}%
          </span>
        </div>
      </div>
    </div>

    <!-- Detailed Results Grid -->
    <div class="result-grid">
      <div class="result-item">
        <span class="label">Period:</span>
        <span class="value">{{ result.days }} days</span>
      </div>

      <div class="result-item">
        <span class="label">Initial Balance:</span>
        <span class="value">${{ result.initialBalance.toFixed(2) }}</span>
      </div>

      <div class="result-item">
        <span class="label">Final Balance:</span>
        <span class="value">${{ result.finalBalance.toFixed(2) }}</span>
      </div>

      <div class="result-item">
        <span class="label">Total Trades:</span>
        <span class="value">{{ result.totalTrades }}</span>
      </div>

      <div class="result-item">
        <span class="label">Buy Trades:</span>
        <span class="value">{{ result.buyTrades }}</span>
      </div>

      <div class="result-item">
        <span class="label">Sell Trades:</span>
        <span class="value">{{ result.sellTrades }}</span>
      </div>
    </div>

    <!-- Performance Summary -->
    <div class="performance-summary">
      <h4>Performance Summary</h4>
      <p *ngIf="result.profitLoss > 0" class="success">
        Your strategy would have made a profit of ${{ result.profitLoss.toFixed(2) }}
        over {{ result.days }} days! That's a {{ result.profitLossPercentage.toFixed(2) }}% return.
      </p>
      <p *ngIf="result.profitLoss < 0" class="warning">
        Your strategy would have lost ${{ Math.abs(result.profitLoss).toFixed(2) }}
        over {{ result.days }} days ({{ result.profitLossPercentage.toFixed(2) }}%). Consider adjusting your parameters.
      </p>
      <p *ngIf="result.profitLoss === 0" class="neutral">
        Your strategy broke even over {{ result.days }} days.
      </p>
    </div>

    <!-- BTC Price Chart -->
    <div class="chart-section" *ngIf="result.historicalPrices && result.historicalPrices.length > 0">
      <div class="chart-header">
        <h4>üìà BTC Price Evolution</h4>
        <button class="btn-reset-zoom" (click)="resetZoom()" title="Reset zoom">üîç Reset Zoom</button>
      </div>
      <p class="chart-instructions">üí° Scroll to zoom, drag to pan</p>
      <div class="chart-container">
        <canvas baseChart
          #chartCanvas
          [data]="lineChartData"
          [options]="lineChartOptions"
          [type]="lineChartType">
        </canvas>
      </div>
    </div>

    <!-- Trades Table -->
    <div class="trades-section" *ngIf="getValidTrades().length > 0">
      <h4>üìã Trade History</h4>
      <p class="table-instructions">üëâ Swipe left to see all columns</p>
      <div class="trades-table-container">
        <table class="trades-table">
          <thead>
            <tr>
              <th>Date/Time</th>
              <th>Type</th>
              <th>Price</th>
              <th>Quantity</th>
              <th>Balance After</th>
              <th>P&L %</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let trade of getValidTrades()" [ngClass]="getTradeTypeClass(trade.type)">
              <td>{{ trade.timestamp | date:'short' }}</td>
              <td class="trade-type">
                <span class="badge" [ngClass]="getTradeTypeClass(trade.type)">
                  {{ trade.type }}
                </span>
              </td>
              <td>${{ trade.price?.toFixed(2) || '0.00' }}</td>
              <td>{{ trade.quantity?.toFixed(6) || '0.000000' }}</td>
              <td>${{ trade.balanceAfter?.toFixed(2) || '0.00' }}</td>
              <td [ngClass]="getProfitLossClass(trade.profitLossPercentage)">
                {{ formatProfitLoss(trade.profitLossPercentage) }}
              </td>
            </tr>
          </tbody>
        </table>
        <div class="trade-count">
          Total trades: {{ getValidTrades().length }}
        </div>
      </div>
    </div>
  </div>
</div>
